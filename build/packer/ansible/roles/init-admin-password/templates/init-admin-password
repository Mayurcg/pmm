#!/bin/sh

PATH=/bin:/sbin
SOURCE=

if [ -f /srv/firstboot ]; then
  return 0
fi

if [ -f /var/lib/cloud/data/status.json ]; then
    SOURCE=$(
        cat /var/lib/cloud/data/status.json 2>/dev/null \
            | python -c 'import json, sys; print json.load(sys.stdin)["v1"]["datasource"];' 2>/dev/null
    )
fi

if [ "x$SOURCE" = "xDataSourceEc2" ]; then
    INSTANCE_ID=$(curl --connect-timeout 5 -s http://169.254.169.254/latest/meta-data/instance-id)
    podman exec pmm-server change-admin-password $INSTANCE_ID
fi

# Create the marker file
touch /srv/firstboot

