- name: Set distribution for OVF
  when: ansible_virtualization_type == "virtualbox"
  copy:
    content: ovf
    dest: /srv/pmm-distribution

- name: Set distribution for AMI
  when: >
    ( ansible_virtualization_type == "xen"
    or ansible_virtualization_type == "kvm" )
    and ansible_system_vendor != "DigitalOcean"
  copy:
    content: ami
    dest: /srv/pmm-distribution

- name: Set SELinux in permissive mode for watchtower
  selinux:
    policy: targeted
    state: permissive

- name: Pull the PMM image
  command: podman pull {{ pmm_server_image_name }}
  become: true
  become_user: admin

- name: Create a volume on the host
  command: podman volume create pmm-data
  become: true
  become_user: admin

- name: Create a network
  command: podman network create pmm_default
  become: true
  become_user: admin

- name: Enable privileged port
  become: true
  sysctl:
    name: net.ipv4.ip_unprivileged_port_start
    value: 443

- name: Get user ID of admin user
  command: id -u admin
  register: admin_user_id

- name: Enable linger for the admin user
  command: loginctl enable-linger {{ admin_user_id.stdout }}

- name: Enable and start podman-restart user service
  command: systemctl --user enable --now podman-restart
  become: true
  become_user: admin
  environment:
    DBUS_SESSION_BUS_ADDRESS: "unix:path=/run/user/{{ admin_user_id.stdout }}/bus"

- name: Run PMM via Podman in rootless mode
  command: >
    podman run -d --volume pmm-data:/srv/ --name pmm-server
               -e PMM_WATCHTOWER_HOST="http://watchtower:8080"
               -e PMM_WATCHTOWER_TOKEN="123"
               -e PMM_SERVER_UPDATE_VERSION={{ pmm_server_image_name }}
               --net pmm_default
               --cap-add=net_admin,net_raw
               -p 443:8443/tcp
               --ulimit=host
               --restart=always
               docker.io/perconalab/pmm-server-fb:PR-3562-3809b3c
  become: true
  become_user: admin

- name: Pause for 1 minute
  pause:
    seconds: 120

- name: Enable socket
  command: systemctl --user enable --now podman.socket
  become: true
  become_user: admin
  environment:
    DBUS_SESSION_BUS_ADDRESS: "unix:path=/run/user/{{ admin_user_id.stdout }}/bus"

- name: Run watchtower via Podman in rootless mode
  command: >
    podman run -d -v /run/user/{{ admin_user_id.stdout }}/podman/podman.sock:/var/run/docker.sock 
               --name watchtower
               -e WATCHTOWER_HTTP_API_UPDATE="1"
               -e WATCHTOWER_HTTP_API_TOKEN="123"
               --net pmm_default
               --cap-add=net_admin,net_raw
               -p 8080:8080/tcp
               --restart=always
               docker.io/perconalab/watchtower
  become: true
  become_user: admin

- name: List running containers via Podman
  command: podman ps -a
  become: true
  become_user: admin