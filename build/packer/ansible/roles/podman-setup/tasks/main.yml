- name: Set distribution for OVF
  when: ansible_virtualization_type == "virtualbox"
  copy:
    content: ovf
    dest: /srv/pmm-distribution

- name: Set distribution for AMI
  when: >
    ( ansible_virtualization_type == "xen"
    or ansible_virtualization_type == "kvm" )
    and ansible_system_vendor != "DigitalOcean"
  copy:
    content: ami
    dest: /srv/pmm-distribution

- name: Disable SELinux
  selinux:
    policy: targeted
    state: permissive

- name: Pull the PMM image
  command: podman pull {{ pmm_server_image_name }}
  become: true
  become_user: admin

- name: Create a volume on the host
  command: podman volume create pmm-data
  become: true
  become_user: admin

- name: Create a network
  command: podman network create pmm_default
  become: true
  become_user: admin

- name: Enable socket
  command: systemctl --user start podman.socket
  become: true
  become_user: admin

- name: Enable privileged port
  become: true
  sysctl:
    name: net.ipv4.ip_unprivileged_port_start
    value: 443

- name: Create user-specific systemd directory
  file:
    path: /home/admin/.config/systemd/user/
    state: directory
    owner: admin
    group: admin
    mode: '0755'

- name: Copy pmm-server systemd service file to user-specific directory
  template:
    src: pmm-server.service
    dest: /home/admin/.config/systemd/user/
    owner: admin
    group: admin
    mode: '0644'

- name: Copy pmm-server environment file for service
  template:
    src: pmm-server.env
    dest: /home/admin/.config/systemd/user/
    owner: admin
    group: admin
    mode: '0644'

- name: Copy watchtower systemd service file to user-specific directory
  template:
    src: watchtower.service
    dest: /home/admin/.config/systemd/user/
    owner: admin
    group: admin
    mode: '0644'

- name: Get user ID of admin user
  command: id -u admin
  register: admin_user_id

- name: Enable linger for the admin user
  command: loginctl enable-linger {{ admin_user_id.stdout }}

- name: Enable and start watchtower container as a user service
  command: systemctl --user enable --now watchtower
  become: true
  become_user: admin
  environment:
    DBUS_SESSION_BUS_ADDRESS: "unix:path=/run/user/{{ admin_user_id.stdout }}/bus"

- name: Enable and start PMM container as a user service
  command: systemctl --user enable --now pmm-server
  become: true
  become_user: admin
  environment:
    DBUS_SESSION_BUS_ADDRESS: "unix:path=/run/user/{{ admin_user_id.stdout }}/bus"
